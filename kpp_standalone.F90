program main


! The KPP Standalone for GEOS-Chem Mechanism Analysis
! 
! 
! Program Description:
! 
! This program runs the GEOS-Chem KPP Standalone for a given set of initial conditions.
! It reads an input file generated by the KPP Standalone Interface that generates model
! output of the full chemical state of grid cells in 3D GEOS-Chem, GCHP, and GEOS-CF runs.
! The full mechanism is run to replicate the chemistry of the specified grid cell.
! Obin Sturm (psturm@usc.edu), Michael S Long, Christoph Keller

! The KPP Standalone is adapted from a box model used in the following publication:
! Lin, H., Long, M. S., Sander, R., Sandu, A., Yantosca, R. M., Estrada, L. A., et al. (2023). 
!  An adaptive auto-reduction solver for speeding up integration of chemical kinetics in atmospheric chemistry models: 
!  Implementation and evaluation in the Kinetic Pre-Processor (KPP) version 3.0.0. 
!  Journal of Advances in Modeling Earth Systems, 15, e2022MS003293. https://doi.org/10.1029/2022MS003293

! Updates:
!  - 2024/04/25, Obin Sturm: Simplification of the code for the GEOS-Chem KPP Standalone,
!                            removed all autoreduce and convergence criteria testing.
!                            The more general tool just runs one operator timestep 
!                            and then prints out the results to an output file.

  USE GCKPP_GLOBAL
  USE GCKPP_JACOBIANSP
  USE GCKPP_PARAMETERS
  USE GCKPP_MONITOR
  USE GCKPP_MODEL
  USE KPP_STANDALONE_INIT, ONLY: read_input


  IMPLICIT NONE

  INTEGER                :: ICNTRL(20), IERR, I
  INTEGER                :: ISTATUS(20)
  INTEGER                :: fileTotSteps
  INTEGER                :: level
  REAL(dp)               :: OperatorTimestep
  REAL(dp)               :: RCNTRL(20)
  REAL(dp)               :: Hstart
  REAL(dp)               :: cosSZA
  REAL(dp)               :: RSTATE(20)
  REAL(dp)               :: T, TIN, TOUT, start, end
  REAL :: full_sumtime, full_avg

  INTEGER :: NRTOL, NSTEPSt ! Number of iterations in the timing averaging loop

  REAL(dp)             :: Vloc(NVAR), Cinit(NSPEC), R(NREACT)

  LOGICAL              :: OUTPUT
  LOGICAL              :: ReInit
  

  ! Vars for reading files
  character(len=256) :: inputfile
  character(len=256) :: outputfile


  OUTPUT       = .false.
  REINIT       = .true.  ! Reset C every NITR,NRTOL iteration
!  REINIT       = .false. ! Let C evolve over the NRTOL loop
  NRTOL         = 25


  ! Check if an argument was provided
  if (command_argument_count() .ge. 1) then
   ! Get the first argument
   call get_command_argument(1, inputfile)
   print*, 'Processing sample: ', trim(inputfile)
  else 
   print*, 'No sample provided. Exiting.'
  endif

  ! Read the input file
  call read_input(inputfile, R, Cinit, SPC_NAMES, Hstart, cosSZA, level, fileTotSteps, OperatorTimestep)


  
  ! Run the full mechanism
  call fullmech(RTOL_VALUE=0.5e-2_dp)

  ! Write the output file (not working yet)
!   outputfile = "StandaloneOutput_"//trim(inputfile)
!   call write_output(inputfile,outputfile)

CONTAINS

  subroutine fullmech(RTOL_VALUE)
    USE GCKPP_INTEGRATOR
    USE GCKPP_RATES
    USE GCKPP_INITIALIZE
    USE GCKPP_GLOBAL

    IMPLICIT NONE

    REAL(dp)    :: RTOL_VALUE

    ! Set OPTIONS
    IERR      = 0                 ! Success or failure flag
    ISTATUS   = 0                 ! Rosenbrock output 
    RCNTRL    = 0.0_dp            ! Rosenbrock input
    RCNTRL(3) = Hstart
    RSTATE    = 0.0_dp            ! Rosenbrock output
    ICNTRL    = 0
    ICNTRL(1) = 1
    ICNTRL(2) = 0.000_dp
    ICNTRL(3) = 4
    ICNTRL(7) = 1
    ICNTRL(15) = -1
    
    ! Tolerances
    ATOL      = 1e-2_dp
    RTOL      = RTOL_VALUE ! default in GEOS-CF 2.0 is 0.5e-2_dp

    ! Set ENV
    T    = 0d0
    TIN  = T
    TOUT = T + OperatorTimestep
    TEMP = 298.
        
    full_avg     = 0.
    full_sumtime = 0.
    start        = 0.
    end          = 0.

    ! Initialize concentrations
    C(1:NSPEC) = Cinit(1:NSPEC)
    ! Assign RCONST to rate constants from file
    ! rather than
    !  call Update_RCONST()
    RCONST = R

    ! Integrate the mechanism for an operator timestep
    CALL Integrate( TIN,    TOUT,    ICNTRL,      &
         RCNTRL, ISTATUS, RSTATE, IERR )
    NSTEPSt = ISTATUS(3)
    write(*,'(a,i5)') " Number of internal timesteps: ", ISTATUS(3)

    ! Run the RTOL variation loop
    DO I=1,NRTOL       
       call Initialize()
       C(1:NSPEC) = Cinit(1:NSPEC)

       VAR(1:NVAR) => C(1:NVAR)
       FIX(1:NFIX) => C(NVAR+1:NSPEC)
       ! Set RCONST
      !  call Update_RCONST()

       CALL Fun( C, FIX, RCONST, Vloc )

       ! Get a random RTOL
      !  CALL RANDOM_NUMBER(RTOL)
      !  RTOL = 10**(-2.*RTOL)

       ! Integrate
       CALL Integrate( TIN,    TOUT,    ICNTRL,      &
            RCNTRL, ISTATUS, RSTATE, IERR )
       call cpu_time(end)
    ENDDO


    return
 end subroutine fullmech

!  subroutine write_output(inputfile, outputfile)
!     character(len=256) :: outputfile
!     character(len=256) :: inputfile
!     integer :: num_header
!     integer :: i
!     character(len=256) :: line

!     ! Read the first line of the input file containing the lines of header
!       open(10, file=inputfile, status='old')
!       read(10,*) num_header
!       close(10)

!       ! Write num_header lines of the input to the output file
!       open(20, file=outputfile, status='unknown')
!       write(20,*) num_header
!       open(10, file=inputfile, status='old')
!       do i=1,num_header
!          read(10,*) line
!          write(20,*) line
!       enddo
!       close(10)
!  end subroutine write_output

end program main
